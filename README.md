# BranchPilot — Azure DevOps Extension

> Create branches from Work Items with smart naming rules, automatic linking, and full configurability.

---

## Features

| Feature | Details |
|---|---|
| **Create branch from Work Item** | One click from the WI context menu |
| **Smart naming rules** | Glob & regex rules on source branch, per-WI-type rules, fallback default |
| **Automatic WI linking** | Branch is linked to the WI immediately after creation (standard Azure DevOps link) |
| **Always asks repo + source** | No implicit assumptions — user always selects repository and "Based on" branch |
| **Configurable state update** | Optionally move WI to "Active" (or any state) on branch creation |
| **Per-project settings** | Full settings hub in Project Settings → BranchPilot |
| **Export / Import config** | JSON export and import for sharing or backup |
| **i18n** | UI in English and Italian |

---

## Installation

### From the Marketplace

1. Install from [Visual Studio Marketplace](https://marketplace.visualstudio.com/items?itemName=FeliceLombardi.branch-pilot).
2. Open any Azure DevOps project.
3. Navigate to **Project Settings → BranchPilot** to configure.

### Local / Private install (development)

```bash
# 1. Clone and install dependencies
git clone https://github.com/managerfx/branch-pilot-az-devops.git
cd branch-pilot
npm install

# 2. Build
npm run build

# 3. Package as .vsix
npm run package

# 4. Install in your organisation via the Manage Extensions page
#    (Org Settings → Extensions → Upload/Install)
```

---

## Usage

1. Open any **Work Item** (must be saved — it needs an ID).
2. Click the `⋯` context menu → **BranchPilot: Create branch**.
3. A dialog opens:
   - **Repository** — select target repo.
   - **Based on** — select source branch (default = repo's default branch).
   - **Branch name** — auto-generated; editable if allowed by settings.
4. Click **Create**.

The branch is created and linked to the Work Item. You stay on the Work Item page.

---

## Naming Rules

Branch names are generated by a **rules engine** with the following precedence:

```
1. rulesBySourceBranch  ← first match wins (glob or regex on the "Based on" branch)
2. rulesByWorkItemType  ← first match wins (case-insensitive WI type)
3. defaults             ← fallback template
```

### Built-in defaults

| Source branch pattern | Result prefix | Example output |
|---|---|---|
| `hotfix/*` (glob) | `hotfix/` | `hotfix/42-fix-critical-bug` |
| `hotfix` (regex `^hotfix$`) | `hotfix/` | `hotfix/42-fix-critical-bug` |
| `release/*` (glob) | `release/` | `release/42-add-login-feature` |
| WI type = Bug | `bugfix/` | `bugfix/42-fix-crash-on-login` |
| WI type = User Story | `feature/` | `feature/42-add-login-feature` |
| *(default)* | *(none)* | `feature/42-add-login-feature` |

### Template tokens

| Token | Value |
|---|---|
| `{wi.id}` | Work Item ID |
| `{wi.title}` | Work Item title (sanitized) |
| `{wi.type}` | Work Item type (e.g. `Bug`) |
| `{wi.state}` | Work Item state |
| `{wi.assignedTo}` | Assigned to display name |
| `{prefix}` | Prefix from the matched rule |

### Sanitization

- Non-alphanumeric characters → `-` (configurable)
- Consecutive replacements are collapsed
- Leading/trailing hyphens stripped
- **Always lowercase** (configurable)
- Truncated to `maxLength` characters (default: 80), preserving the WI ID

---

## Configuration

Open **Project Settings → BranchPilot** to configure. Settings are stored per-project.

### General

```json
{
  "general": {
    "lowercase": true,
    "nonAlnumReplacement": "-",
    "maxLength": 80,
    "allowManualNameOverride": true
  }
}
```

| Field | Description |
|---|---|
| `lowercase` | Force branch names to lowercase (recommended: `true`) |
| `nonAlnumReplacement` | Character used to replace non-alphanumeric chars (default: `"-"`) |
| `maxLength` | Maximum branch name length (default: `80`, hard limit: `250`) |
| `allowManualNameOverride` | Allow users to manually edit the generated branch name |

### Full config schema

```jsonc
{
  "schemaVersion": 1,
  "general": {
    "lowercase": true,
    "nonAlnumReplacement": "-",
    "maxLength": 80,
    "allowManualNameOverride": true
  },
  "defaults": {
    "template": "feature/{wi.id}-{wi.title}",
    "workItemState": { "enabled": false, "state": "Active" }
  },
  "repoOverrides": {
    "my-repo-name": {
      "defaultTemplate": "custom/{wi.id}-{wi.title}"
    }
  },
  "rulesBySourceBranch": [
    {
      "name": "Hotfix branch rule",
      "matchType": "glob",       // "glob" | "regex"
      "match": "hotfix/*",
      "prefix": "hotfix/",
      "template": "{prefix}{wi.id}-{wi.title}",
      "workItemState": { "enabled": true, "state": "In Progress" }
    }
  ],
  "rulesByWorkItemType": [
    {
      "workItemType": "Bug",
      "prefix": "bugfix/",
      "template": "{prefix}{wi.id}-{wi.title}",
      "workItemState": { "enabled": true, "state": "Active" }
    }
  ]
}
```

### Export / Import

In **Project Settings → BranchPilot**:
- **Export JSON** — downloads the current config as `branchpilot-config.json`.
- **Import JSON** — loads a previously exported config (or import from another project).

---

## Development

### Prerequisites

- Node.js ≥ 18
- `tfx-cli` installed globally: `npm i -g tfx-cli`

### Scripts

```bash
npm run build         # Production build → dist/
npm run build:dev     # Development build (source maps)
npm run watch         # Watch mode
npm run test          # Run unit tests
npm run test:watch    # Watch tests
npm run package       # Build + create .vsix
```

### Project structure

```
branch-pilot/
├── src/
│   ├── action/              # Hidden-iframe action handler
│   │   ├── action.ts
│   │   └── index.html
│   ├── modal/               # Branch creation dialog
│   │   ├── modal.tsx
│   │   ├── modal.scss
│   │   └── index.html
│   ├── settings/            # Project Settings hub
│   │   ├── settings.tsx
│   │   ├── settings.scss
│   │   └── index.html
│   ├── services/
│   │   ├── ConfigService.ts
│   │   ├── WorkItemService.ts
│   │   ├── RepoService.ts
│   │   ├── BranchService.ts
│   │   └── Logger.ts
│   ├── rules/
│   │   ├── RulesEngine.ts
│   │   └── TemplateRenderer.ts
│   ├── common/
│   │   ├── types.ts
│   │   ├── constants.ts
│   │   └── utils.ts
│   ├── i18n/
│   │   ├── en.ts
│   │   ├── it.ts
│   │   └── index.ts
│   └── __tests__/
│       ├── utils.test.ts
│       ├── TemplateRenderer.test.ts
│       └── RulesEngine.test.ts
├── assets/
│   └── icons/
├── vss-extension.json
├── webpack.config.js
├── tsconfig.json
└── package.json
```

### Publishing to Marketplace

1. Create a publisher at [marketplace.visualstudio.com/manage](https://marketplace.visualstudio.com/manage).
2. Update `publisher` in `vss-extension.json` and `constants.ts`.
3. Set `"public": true` in `vss-extension.json`.
4. Run `npm run package` to generate the `.vsix`.
5. Upload via the Marketplace portal or: `tfx extension publish --vsix branch-pilot-1.0.0.vsix`.

---

## Troubleshooting

| Symptom | Solution |
|---|---|
| "Save the Work Item before creating a branch" | The WI must be saved (have an ID) before using BranchPilot. |
| Branch dialog doesn't open | Ensure the extension is installed and you have the necessary permissions. |
| "You don't have permission to create branches" | Your account needs `GenericContribute` on the Git repository. |
| Branch name is not auto-generated | Check that a repository and source branch are selected. |
| Settings not saving | Ensure you're a Project Administrator. |

### Diagnostic details

When an error occurs, a collapsible **Diagnostic details** section appears in the dialog.
Click **Copy diagnostics** to copy a JSON blob with the full error log — useful when filing bug reports.

---

## License

MIT © FeliceLombardi
